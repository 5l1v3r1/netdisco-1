version: 2
jobs:
  build:
    docker:
      - image: ruby:2.4.1
    steps:
      - checkout
      - run: cd /root/project && echo "export HEAD_TAG=$(git tag -l | grep -E '^2\.[0-9]{6}' | sort -gr | head -n1)" >> $BASH_ENV
      - run: . $BASH_ENV && cd /root/project && echo "export TAG=$(echo $HEAD_TAG | sed -E 's/\.[0-9]{3}$//')" >> $BASH_ENV
      - run:
          name: Call GitHub Releases API
          command: |
            . $BASH_ENV && if [ ! -z "$TAG" ]; then
              for url in $(echo $RELEASE_INJECTION | sed "s/,/ /g"); do
                curl -sL -X POST -H "Content-Type: application/json" \
                  -u "$ACCESS_TOKEN" \
                  --data "{\"tag_name\": \"$TAG\", \
                           \"target_commitish\": \"master\", \
                           \"name\": \"Netdisco $TAG\"}" \
                  $url
              done
            fi
